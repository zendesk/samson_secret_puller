#!/usr/bin/env ruby
STDOUT.sync = true
require_relative "../lib/secrets"

true_env = ['1', 'true']

client = SecretsClient.new(
  vault_address: ENV.fetch("VAULT_ADDR") || raise("VAULT_ADDR not provided"),
  vault_mount: ENV["VAULT_MOUNT"] || "secret",
  vault_prefix: ENV["VAULT_PREFIX"] || "apps",
  vault_authfile_path: ENV["VAULT_AUTH_FILE"] || '/vault-auth/authsecret',
  ssl_verify: true_env.include?(ENV["VAULT_TLS_VERIFY"]),
  annotations: ENV["SECRET_ANNOTATIONS"] || '/secretkeys/annotations',
  serviceaccount_dir: ENV["SERVICEACCOUNT_DIR"] || '/var/run/secrets/kubernetes.io/serviceaccount/',
  output_path: ENV["SIDECAR_SECRET_PATH"] || '/secrets',
  api_url: (ENV["TESTING"] ? 'http://' : 'https://') + ENV.fetch("KUBERNETES_PORT_443_TCP_ADDR"),
  vault_v2: true_env.include?(ENV["VAULT_KV_V2"])
)

client.write_secrets
