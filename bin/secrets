#!/usr/bin/env ruby
require_relative "../lib/secrets.rb"

vault_address = ENV.fetch("VAULT_ADDR") || raise("VAULT_ADDR not provided")
vault_auth_pem = ENV["VAULT_AUTH_PEM"] || '/vault-auth/pem'
vault_tls_verify = ['1', 'true'].include?(ENV["VAULT_TLS_VERIFY"])
sidecar_secret_path = ENV["SIDECAR_SECRET_PATH"] || '/secrets'
annotations = ENV["SECRET_ANNOTATIONS"] || '/secretkeys/annotations'

client = SecretsClient.new(
  vault_address: vault_address,
  pemfile_path: vault_auth_pem,
  ssl_verify: vault_tls_verify,
  annotations: annotations,
  output_path: sidecar_secret_path
)

loop do
  client.write_secrets
  if ENV["TESTING"]
    break
  else
    sleep 600
  end
end
